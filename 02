import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

# Configura√ß√µes de layout
st.set_page_config(page_title="Kite For Life - Sistema de Gest√£o", layout="wide")

# Lista de crit√©rios conforme a tua planilha
CRITERIOS = [
    'LIDERAN√áA', 'ASSIDUIDADE', 'FLEXIBILIDADE', 'TEORIA',
    'COMANDO', 'CONTROLE', 'BADYDRAG ESQ/DIR', 'WATER START',
    'PRANCHA ESQ/DIR', 'CONTRA VENTO'
]

def carregar_dados_de_arquivo(uploaded_file):
    if uploaded_file is None:
        return None
    fname = uploaded_file.name.lower()
    try:
        if fname.endswith(('.xls', '.xlsx', '.xlsm')):
            # Ler a primeira folha ou uma folha espec√≠fica conforme necess√°rio
            df = pd.read_excel(uploaded_file, sheet_name=0, skiprows=11)
        else:
            # csv
            df = pd.read_csv(uploaded_file, skiprows=11)
        # Remover colunas unnamed
        df = df.loc[:, ~df.columns.str.contains('^Unnamed', na=False)]
        return df
    except Exception as e:
        st.warning(f"Falha ao ler o ficheiro: {e}")
        return None

# Tentar carregar ficheiro local default (√∫til para desenvolvimento)
DEFAULT_FILENAME = "kite f lifeavaliacao_de_desempenho_-_2025.xlsm - Aval.csv"

st.sidebar.header("üåä Kite For Life v2025")
menu = st.sidebar.selectbox("Navega√ß√£o", ["Painel Geral", "Ficha do Aluno", "Lan√ßar Novas Notas"])

st.sidebar.markdown("**Carregar ficheiro de dados (opcional):**")
uploaded = st.sidebar.file_uploader("Escolhe um .xls/.xlsx/.xlsm/.csv", type=["xls", "xlsx", "xlsm", "csv"])

df_notas = carregar_dados_de_arquivo(uploaded)

# Se n√£o carregou nada, tentar carregar um ficheiro local com nome padr√£o (apenas em dev local)
if df_notas is None:
    try:
        df_notas = pd.read_csv(DEFAULT_FILENAME, skiprows=11)
        df_notas = df_notas.loc[:, ~df_notas.columns.str.contains('^Unnamed', na=False)]
    except Exception:
        # Fallback com dados de exemplo
        df_notas = pd.DataFrame({
            'Aluno': ['Beatriz Vitoria', 'Ana Cecilia', 'Francisco Neto'],
            # Criar colunas por crit√©rio com valores de exemplo (ou usar apenas 'M√©dia Geral')
            'LIDERAN√áA': [3, 2, 4],
            'ASSIDUIDADE': [3, 2, 4],
            'FLEXIBILIDADE': [3, 3, 4],
            'TEORIA': [3, 1, 4],
            'COMANDO': [3, 2, 4],
            'CONTROLE': [3, 2, 4],
            'BADYDRAG ESQ/DIR': [3, 3, 4],
            'WATER START': [3, 2, 4],
            'PRANCHA ESQ/DIR': [3, 2, 4],
            'CONTRA VENTO': [3, 1, 4],
            'M√©dia Geral': [3.0, 2.0, 3.9]
        })

# --- P√ÅGINA 1: PAINEL GERAL ---
if menu == "Painel Geral":
    st.title("üìä Indicadores da Escola")
    
    col1, col2, col3 = st.columns(3)
    media_escola = 2.26  # Valor extra√≠do do teu 'Dash2' (pode ser calculado dinamicamente)
    col1.metric("M√©dia da Escola", f"{media_escola}")
    col2.metric("Total de Alunos", len(df_notas))
    col3.metric("Status", "Em Evolu√ß√£o")

    st.subheader("Desempenho M√©dio por Habilidade")
    # Se o dataframe tiver as colunas de crit√©rio, calcular m√©dia real; sen√£o usar valores fixos
    medias = None
    if set(CRITERIOS).issubset(df_notas.columns):
        medias = [df_notas[c].mean() for c in CRITERIOS]
    else:
        medias = [2.24, 3.35, 2.47, 2.18, 2.18, 2.12, 2.47, 2.06, 1.88, 1.71]
    
    df_dash2 = pd.DataFrame({
        'Crit√©rio': CRITERIOS,
        'M√©dia': medias
    })
    fig_bar = px.bar(df_dash2, x='Crit√©rio', y='M√©dia', color='M√©dia', 
                     color_continuous_scale='Blues', range_y=[0, 5])
    st.plotly_chart(fig_bar, use_container_width=True)
    
# --- P√ÅGINA 2: FICHA DO ALUNO ---
elif menu == "Ficha do Aluno":
    st.title("üë§ An√°lise Individual")
    if 'Aluno' not in df_notas.columns:
        st.warning("O ficheiro de dados n√£o cont√©m a coluna 'Aluno'. Carrega um ficheiro compat√≠vel ou corrige o nome da coluna.")
    else:
        aluno_sel = st.selectbox("Selecione o Aluno:", df_notas['Aluno'].unique())
        dados_aluno = df_notas[df_notas['Aluno'] == aluno_sel].iloc[0]
        notas_aluno = []
        for c in CRITERIOS:
            # se a coluna existir no ficheiro, usa-a, caso contr√°rio assume 0
            notas_aluno.append(float(dados_aluno[c]) if c in df_notas.columns else 0.0)

        fig = go.Figure()
        fig.add_trace(go.Scatterpolar(r=notas_aluno, theta=CRITERIOS, fill='toself', name='Este Aluno'))
        fig.add_trace(go.Scatterpolar(r=[2.26]*len(CRITERIOS), theta=CRITERIOS, name='M√©dia Escola', 
                                      line=dict(dash='dash', color='gray')))
        fig.update_layout(polar=dict(radialaxis=dict(visible=True, range=[0, 5])), showlegend=True)
        st.plotly_chart(fig, use_container_width=True)

# --- P√ÅGINA 3: LAN√áAR NOTAS ---
elif menu == "Lan√ßar Novas Notas":
    st.title("üìù Formul√°rio de Avalia√ß√£o")
    if 'Aluno' not in df_notas.columns:
        st.warning("N√£o h√° coluna 'Aluno' nos dados. A op√ß√£o de lan√ßamento funciona melhor com uma base que contenha 'Aluno'.")
    with st.form("registro"):
        nome = st.selectbox("Escolha o Aluno", df_notas['Aluno'].unique() if 'Aluno' in df_notas.columns else ["Aluno Exemplo"])
        st.write("Atribua notas de 1 (Ruim) a 5 (Marcante):")
        
        c1, c2 = st.columns(2)
        notas_novas = {}
        for i, crit in enumerate(CRITERIOS):
            with (c1 if i % 2 == 0 else c2):
                notas_novas[crit] = st.select_slider(crit, options=[1, 2, 3, 4, 5], value=3)
        
        coment = st.text_area("Observa√ß√µes de campo")
        if st.form_submit_button("Guardar Avalia√ß√£o"):
            # Aqui apenas mostramos a avalia√ß√£o - para guardar no reposit√≥rio/BD precisas de integra√ß√£o (ex.: Google Sheets, DB, S3)
            st.success(f"Avalia√ß√£o de {nome} registada com sucesso no sistema!")
            st.json({"aluno": nome, "notas": notas_novas, "coment": coment})
